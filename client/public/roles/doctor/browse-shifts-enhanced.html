<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browse Shifts - Nocturnal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #5B8DBE;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --light: #f8f9fa;
            --dark: #2C3E50;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #E8EAF6 0%, #C5CAE9 50%, #D1C4E9 100%);
            min-height: 100vh;
        }

        .navbar {
            background: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .nav-links a {
            text-decoration: none;
            color: #475569;
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-links a:hover,
        .nav-links a.active {
            color: var(--primary);
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .page-header {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .page-header h1 {
            color: var(--dark);
            margin-bottom: 0.5rem;
            font-size: 2rem;
        }

        .page-header p {
            color: #666;
            font-size: 1.05rem;
        }

        /* Filters */
        .filters-card {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .filters-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .filter-control {
            padding: 0.75rem 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .filter-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        .quick-filters {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }

        .quick-filter-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .quick-filter-btn.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .filter-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #4A7099;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: var(--dark);
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        /* Results */
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .results-count {
            font-size: 1.1rem;
            color: #666;
        }

        .sort-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .sort-controls label {
            font-weight: 600;
            color: var(--dark);
        }

        .sort-controls select {
            padding: 0.5rem 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
        }

        /* Shift Cards */
        .shifts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .shift-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: all 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .shift-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            border-color: var(--primary);
        }

        .shift-card.urgent {
            border-left: 4px solid var(--danger);
        }

        .shift-card.high-match {
            border: 2px solid var(--success);
        }

        .shift-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .hospital-info {
            flex: 1;
        }

        .hospital-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 0.25rem;
        }

        .hospital-rating {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: #666;
        }

        .stars {
            color: #ffc107;
        }

        .match-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .match-excellent {
            background: #d4edda;
            color: #155724;
        }

        .match-good {
            background: #d1ecf1;
            color: #0c5460;
        }

        .match-fair {
            background: #fff3cd;
            color: #856404;
        }

        .shift-details {
            margin: 1rem 0;
        }

        .detail-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            color: #666;
            font-size: 0.95rem;
        }

        .detail-row i {
            width: 20px;
            color: var(--primary);
        }

        .specialty-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .compensation {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
        }

        .comp-rate {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--success);
            margin-bottom: 0.25rem;
        }

        .comp-total {
            font-size: 0.9rem;
            color: #666;
        }

        .perks {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .perk-tag {
            padding: 0.4rem 0.75rem;
            background: #e8f5e9;
            color: var(--success);
            border-radius: 15px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .shift-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 2px solid #f0f0f0;
        }

        .urgency-tag {
            padding: 0.4rem 0.75rem;
            border-radius: 15px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .urgent-tag {
            background: #fff3cd;
            color: #856404;
        }

        .emergency-tag {
            background: #f8d7da;
            color: #721c24;
        }

        .spots-left {
            font-size: 0.9rem;
            color: var(--danger);
            font-weight: 600;
        }

        .btn-apply {
            padding: 0.75rem 1.5rem;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-apply:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .no-results {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .no-results i {
            font-size: 4rem;
            color: #ccc;
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .filter-grid {
                grid-template-columns: 1fr;
            }

            .shifts-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <script src="/js/config.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="logo">üåô Nocturnal</div>
        <div class="nav-links">
            <a href="/roles/doctor/doctor-dashboard.html">Dashboard</a>
            <a href="/roles/doctor/browse-duties.html" class="active">Browse Shifts</a>
            <a href="/roles/doctor/calendar.html">Calendar</a>
            <a href="/roles/doctor/my-applications.html">Applications</a>
            <a href="/roles/doctor/doctor-profile.html">Profile</a>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1><i class="fas fa-search"></i> Find Shifts</h1>
            <p>Discover and apply for shifts that match your specialty and preferences</p>
        </div>

        <!-- Filters -->
        <div class="filters-card">
            <div class="filters-header">
                <h2 class="filters-title">
                    <i class="fas fa-filter"></i>
                    Filters
                </h2>
                <button class="btn-secondary" onclick="clearFilters()">
                    <i class="fas fa-redo"></i> Clear All
                </button>
            </div>

            <!-- Quick Filters -->
            <div class="quick-filters">
                <button class="quick-filter-btn active" data-date="all" onclick="setDateFilter('all')">All Dates</button>
                <button class="quick-filter-btn" data-date="today" onclick="setDateFilter('today')">Today</button>
                <button class="quick-filter-btn" data-date="tomorrow" onclick="setDateFilter('tomorrow')">Tomorrow</button>
                <button class="quick-filter-btn" data-date="week" onclick="setDateFilter('week')">This Week</button>
                <button class="quick-filter-btn" data-date="custom" onclick="setDateFilter('custom')">Custom Date</button>
            </div>

            <!-- Advanced Filters -->
            <div class="filter-grid">
                <div class="filter-group">
                    <label><i class="fas fa-stethoscope"></i> Specialty</label>
                    <select id="specialtyFilter" class="filter-control">
                        <option value="">All Specialties</option>
                        <option value="Internal Medicine">Internal Medicine</option>
                        <option value="Emergency Medicine">Emergency Medicine</option>
                        <option value="General Surgery">General Surgery</option>
                        <option value="Anaesthesiology">Anaesthesiology</option>
                        <option value="Intensive Care / Critical Care Medicine">ICU / Critical Care</option>
                        <option value="Obstetrics & Gynaecology">Obstetrics & Gynaecology</option>
                        <option value="Orthopaedics">Orthopaedics</option>
                        <option value="Radiology">Radiology</option>
                        <option value="General Paediatrics">Paediatrics</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label><i class="fas fa-clock"></i> Shift Time</label>
                    <select id="timeFilter" class="filter-control">
                        <option value="">All Times</option>
                        <option value="morning">Morning (6AM-2PM)</option>
                        <option value="evening">Evening (2PM-10PM)</option>
                        <option value="night">Night (10PM-6AM)</option>
                        <option value="24hr">24 Hour</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label><i class="fas fa-map-marker-alt"></i> Distance (km)</label>
                    <select id="distanceFilter" class="filter-control">
                        <option value="">Any Distance</option>
                        <option value="5">Within 5km</option>
                        <option value="10">Within 10km</option>
                        <option value="20">Within 20km</option>
                        <option value="50">Within 50km</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label><i class="fas fa-rupee-sign"></i> Min. Pay (‚Çπ/hour)</label>
                    <input type="number" id="minPayFilter" class="filter-control" placeholder="e.g., 1500" min="0" step="100">
                </div>

                <div class="filter-group">
                    <label><i class="fas fa-star"></i> Hospital Rating</label>
                    <select id="ratingFilter" class="filter-control">
                        <option value="">Any Rating</option>
                        <option value="4.5">4.5+ Stars</option>
                        <option value="4.0">4.0+ Stars</option>
                        <option value="3.5">3.5+ Stars</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label><i class="fas fa-calendar"></i> Custom Date</label>
                    <input type="date" id="customDateFilter" class="filter-control">
                </div>
            </div>

            <div class="filter-actions">
                <button class="btn btn-primary" onclick="applyFilters()">
                    <i class="fas fa-check"></i> Apply Filters
                </button>
                <button class="btn btn-secondary" onclick="clearFilters()">
                    <i class="fas fa-times"></i> Clear
                </button>
            </div>
        </div>

        <!-- Results -->
        <div class="results-header">
            <div class="results-count">
                <strong id="resultsCount">0</strong> shifts found
            </div>
            <div class="sort-controls">
                <label>Sort By:</label>
                <select id="sortBy" onchange="applyFilters()">
                    <option value="match">Best Match</option>
                    <option value="nearest">Nearest</option>
                    <option value="highest-paid">Highest Paid</option>
                    <option value="urgent">Urgent First</option>
                    <option value="date">Soonest Date</option>
                </select>
            </div>
        </div>

        <div class="shifts-grid" id="shiftsGrid">
            <!-- Will be populated by JavaScript -->
        </div>

        <div class="no-results" id="noResults" style="display: none;">
            <i class="fas fa-search"></i>
            <h3>No shifts found</h3>
            <p>Try adjusting your filters to see more results</p>
        </div>
    </div>

    <script>
        // API_URL is provided by config.js
        let allShifts = [];
        let currentUser = null;

        // Check authentication
        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/index.html';
                return null;
            }
            return token;
        }

        // Load user profile
        async function loadUser() {
            const token = checkAuth();
            try {
                const response = await fetch(`${API_URL}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (data.success) {
                    currentUser = data.user;
                }
            } catch (error) {
                console.error('Error loading user:', error);
            }
        }

        // Load shifts
        async function loadShifts() {
            const token = checkAuth();
            try {
                const response = await fetch(`${API_URL}/duties?status=OPEN`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (data.success) {
                    allShifts = data.duties || [];
                    applyFilters();
                }
            } catch (error) {
                console.error('Error loading shifts:', error);
            }
        }

        // Set date filter
        window.setDateFilter = function(filter) {
            document.querySelectorAll('.quick-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            if (filter !== 'custom') {
                document.getElementById('customDateFilter').value = '';
            }
        };

        // Apply filters
        window.applyFilters = function() {
            let filtered = [...allShifts];

            // Specialty filter
            const specialty = document.getElementById('specialtyFilter').value;
            if (specialty) {
                filtered = filtered.filter(shift => shift.specialty === specialty);
            }

            // Min pay filter
            const minPay = document.getElementById('minPayFilter').value;
            if (minPay) {
                filtered = filtered.filter(shift => shift.hourlyRate >= parseInt(minPay));
            }

            // Date filters
            const activeDate = document.querySelector('.quick-filter-btn.active').dataset.date;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (activeDate === 'today') {
                filtered = filtered.filter(shift => {
                    const shiftDate = new Date(shift.date);
                    shiftDate.setHours(0, 0, 0, 0);
                    return shiftDate.getTime() === today.getTime();
                });
            } else if (activeDate === 'tomorrow') {
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                filtered = filtered.filter(shift => {
                    const shiftDate = new Date(shift.date);
                    shiftDate.setHours(0, 0, 0, 0);
                    return shiftDate.getTime() === tomorrow.getTime();
                });
            } else if (activeDate === 'week') {
                const weekEnd = new Date(today);
                weekEnd.setDate(weekEnd.getDate() + 7);
                filtered = filtered.filter(shift => {
                    const shiftDate = new Date(shift.date);
                    return shiftDate >= today && shiftDate <= weekEnd;
                });
            }

            // Custom date
            const customDate = document.getElementById('customDateFilter').value;
            if (customDate) {
                const targetDate = new Date(customDate);
                targetDate.setHours(0, 0, 0, 0);
                filtered = filtered.filter(shift => {
                    const shiftDate = new Date(shift.date);
                    shiftDate.setHours(0, 0, 0, 0);
                    return shiftDate.getTime() === targetDate.getTime();
                });
            }

            // Sort
            const sortBy = document.getElementById('sortBy').value;
            if (sortBy === 'highest-paid') {
                filtered.sort((a, b) => b.hourlyRate - a.hourlyRate);
            } else if (sortBy === 'date') {
                filtered.sort((a, b) => new Date(a.date) - new Date(b.date));
            } else if (sortBy === 'urgent') {
                filtered.sort((a, b) => {
                    const urgencyOrder = { EMERGENCY: 0, URGENT: 1, NORMAL: 2 };
                    return (urgencyOrder[a.urgency] || 2) - (urgencyOrder[b.urgency] || 2);
                });
            }

            displayShifts(filtered);
        };

        // Display shifts
        function displayShifts(shifts) {
            const grid = document.getElementById('shiftsGrid');
            const noResults = document.getElementById('noResults');
            const resultsCount = document.getElementById('resultsCount');

            resultsCount.textContent = shifts.length;

            if (shifts.length === 0) {
                grid.style.display = 'none';
                noResults.style.display = 'block';
                return;
            }

            grid.style.display = 'grid';
            noResults.style.display = 'none';

            grid.innerHTML = shifts.map(shift => {
                const date = new Date(shift.date);
                const matchScore = Math.floor(Math.random() * 30) + 70; // Mock match score
                const spotsLeft = (shift.positionsNeeded || 1) - (shift.positionsFilled || 0);

                let matchClass = 'match-fair';
                let matchLabel = 'Fair Match';
                if (matchScore >= 90) {
                    matchClass = 'match-excellent';
                    matchLabel = `${matchScore}% Match`;
                } else if (matchScore >= 75) {
                    matchClass = 'match-good';
                    matchLabel = `${matchScore}% Match`;
                }

                return `
                    <div class="shift-card ${shift.urgency === 'URGENT' || shift.urgency === 'EMERGENCY' ? 'urgent' : ''} ${matchScore >= 90 ? 'high-match' : ''}"
                         onclick="viewShift('${shift._id}')">
                        <div class="shift-header">
                            <div class="hospital-info">
                                <div class="hospital-name">${shift.hospitalName || shift.hospital}</div>
                                <div class="hospital-rating">
                                    <span class="stars">‚≠ê 4.8</span>
                                    <span>‚Ä¢ üìç 2.3 km away</span>
                                </div>
                            </div>
                            <div class="match-badge ${matchClass}">${matchLabel}</div>
                        </div>

                        <div class="specialty-badge">
                            <i class="fas fa-stethoscope"></i> ${shift.specialty}
                        </div>

                        <div class="shift-details">
                            <div class="detail-row">
                                <i class="fas fa-calendar"></i>
                                <span>${date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</span>
                            </div>
                            <div class="detail-row">
                                <i class="fas fa-clock"></i>
                                <span>${shift.startTime} - ${shift.endTime} (${shift.duration || 12} hours)</span>
                            </div>
                            <div class="detail-row">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>${shift.location}</span>
                            </div>
                        </div>

                        <div class="compensation">
                            <div class="comp-rate">‚Çπ${shift.hourlyRate.toLocaleString()}/hr</div>
                            <div class="comp-total">Total: ‚Çπ${(shift.totalCompensation || shift.hourlyRate * 12).toLocaleString()}</div>
                        </div>

                        <div class="perks">
                            ${shift.facilities?.mealsProvided?.dinner ? '<span class="perk-tag"><i class="fas fa-utensils"></i> Meals</span>' : ''}
                            ${shift.facilities?.parking ? '<span class="perk-tag"><i class="fas fa-parking"></i> Parking</span>' : ''}
                            <span class="perk-tag"><i class="fas fa-check"></i> Instant Confirm</span>
                        </div>

                        <div class="shift-footer">
                            <div>
                                ${shift.urgency === 'URGENT' ? '<span class="urgency-tag urgent-tag"><i class="fas fa-exclamation-triangle"></i> Urgent</span>' : ''}
                                ${shift.urgency === 'EMERGENCY' ? '<span class="urgency-tag emergency-tag"><i class="fas fa-ambulance"></i> Emergency</span>' : ''}
                                ${spotsLeft <= 2 && spotsLeft > 0 ? `<span class="spots-left">üî• ${spotsLeft} spot${spotsLeft > 1 ? 's' : ''} left</span>` : ''}
                            </div>
                            <button class="btn-apply" onclick="event.stopPropagation(); applyForShift('${shift._id}')">
                                <i class="fas fa-paper-plane"></i> Quick Apply
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // View shift details
        window.viewShift = function(shiftId) {
            window.location.href = `duty-details.html?id=${shiftId}`;
        };

        // Apply for shift
        window.applyForShift = async function(dutyId) {
            const token = checkAuth();
            if (!token) return;

            try {
                const response = await fetch(`${API_URL}/applications`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        dutyId,
                        coverLetter: 'I am interested in this position and believe I am a great fit.'
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert('Application submitted successfully!');
                } else {
                    alert(data.message || 'Failed to apply');
                }
            } catch (error) {
                console.error('Apply error:', error);
                alert('Error submitting application');
            }
        };

        // Clear filters
        window.clearFilters = function() {
            document.getElementById('specialtyFilter').value = '';
            document.getElementById('timeFilter').value = '';
            document.getElementById('distanceFilter').value = '';
            document.getElementById('minPayFilter').value = '';
            document.getElementById('ratingFilter').value = '';
            document.getElementById('customDateFilter').value = '';
            document.getElementById('sortBy').value = 'match';

            document.querySelectorAll('.quick-filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.date === 'all') {
                    btn.classList.add('active');
                }
            });

            applyFilters();
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadUser();
            await loadShifts();
        });
    </script>
    <script src="/js/auto-inject-nav.js"></script>
</body>
</html>
