# Logstash Pipeline Configuration for Nocturnal Healthcare Platform

input {
  # Filebeat input
  beats {
    port => 5044
    codec => json
  }

  # TCP input for application logs
  tcp {
    port => 5000
    codec => json_lines
  }

  # UDP input for syslog
  udp {
    port => 5000
    codec => json_lines
  }

  # File input for direct log monitoring
  file {
    path => "/logs/*.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => json
  }
}

filter {
  # Parse timestamp
  date {
    match => ["timestamp", "ISO8601", "yyyy-MM-dd HH:mm:ss"]
    target => "@timestamp"
  }

  # Add hostname
  mutate {
    add_field => { "application" => "nocturnal-api" }
  }

  # Parse JSON logs
  if [message] =~ /^{.*}$/ {
    json {
      source => "message"
      target => "parsed"
    }
  }

  # Extract log level
  if [level] {
    mutate {
      uppercase => [ "level" ]
      add_tag => [ "%{level}" ]
    }
  }

  # Parse API request logs
  if [service] == "nocturnal-api" {
    grok {
      match => { "message" => "%{TIMESTAMP_ISO8601:timestamp} \[%{LOGLEVEL:level}\]: %{GREEDYDATA:log_message}" }
    }

    # Extract user information
    if [user] {
      mutate {
        add_field => {
          "user_id" => "%{[user][id]}"
          "user_email" => "%{[user][email]}"
          "user_role" => "%{[user][role]}"
        }
      }
    }

    # Extract request information
    if [req] {
      mutate {
        add_field => {
          "http_method" => "%{[req][method]}"
          "http_url" => "%{[req][url]}"
          "http_status" => "%{[req][status]}"
        }
      }
    }
  }

  # Parse error logs
  if [error] {
    mutate {
      add_field => {
        "error_message" => "%{[error][message]}"
        "error_stack" => "%{[error][stack]}"
      }
      add_tag => [ "error" ]
    }
  }

  # Parse authentication events
  if [action] =~ /login|register|logout/ {
    mutate {
      add_tag => [ "authentication" ]
    }
  }

  # Parse booking events
  if [service] == "booking" {
    mutate {
      add_tag => [ "booking" ]
    }
  }

  # Parse payment events
  if [service] == "payment" {
    mutate {
      add_tag => [ "payment" ]
      add_field => { "sensitive_data" => "true" }
    }

    # Mask sensitive payment data
    if [razorpay_payment_id] {
      mutate {
        gsub => [
          "razorpay_payment_id", "^(.{4})(.*)(.{4})$", "\1****\3"
        ]
      }
    }
  }

  # Geographic data enrichment (if IP available)
  if [client_ip] {
    geoip {
      source => "client_ip"
      target => "geoip"
    }
  }

  # Remove unnecessary fields
  mutate {
    remove_field => [ "host", "agent", "ecs", "input" ]
  }
}

output {
  # Output to Elasticsearch
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "nocturnal-logs-%{+YYYY.MM.dd}"
    document_type => "_doc"
  }

  # Output to console for debugging
  stdout {
    codec => rubydebug
  }

  # Conditional outputs based on log level
  if "error" in [tags] or [level] == "ERROR" {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      index => "nocturnal-errors-%{+YYYY.MM.dd}"
    }
  }

  if "payment" in [tags] {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      index => "nocturnal-payments-%{+YYYY.MM.dd}"
    }
  }

  if "authentication" in [tags] {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      index => "nocturnal-auth-%{+YYYY.MM.dd}"
    }
  }
}
