# IMPORTANT: Do NOT define plaintext secrets in this file.
# Use kubectl create secret, or the ExternalSecret below with a secrets manager.
#
# Create secrets manually with kubectl (dev/testing only):
#   kubectl create secret generic nocturnal-secrets \
#     --from-literal=mongodb-uri='mongodb://...' \
#     --from-literal=mongo-root-username='admin' \
#     --from-literal=mongo-root-password='<password>' \
#     --from-literal=redis-password='<password>' \
#     --from-literal=jwt-secret='<64-char-minimum-secret>' \
#     --from-literal=smtp-user='<email>' \
#     --from-literal=smtp-password='<app-password>' \
#     --namespace=nocturnal
#
# ENCRYPTION AT REST:
#   Secrets in etcd must be encrypted. Apply the EncryptionConfiguration below
#   to the kube-apiserver. See k8s/encryption-config.yaml for the config file.
#
#   For managed K8s (EKS/GKE/AKS):
#     - EKS: Enable envelope encryption with a KMS key via aws eks associate-encryption-config
#     - GKE: Enabled by default (Google-managed keys), or use CMEK
#     - AKS: Enable with --enable-azure-keyvault-kms

---
# SecretStore: AWS Secrets Manager backend
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: aws-secrets-manager
  namespace: nocturnal
  labels:
    app: nocturnal
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1
      auth:
        jwt:
          serviceAccountRef:
            name: nocturnal-sa
---
# ExternalSecret: Syncs secrets from AWS Secrets Manager into K8s Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: nocturnal-external-secrets
  namespace: nocturnal
  labels:
    app: nocturnal
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: nocturnal-secrets
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      metadata:
        labels:
          app: nocturnal
        annotations:
          nocturnal.io/managed-by: external-secrets
  data:
  - secretKey: mongodb-uri
    remoteRef:
      key: nocturnal/mongodb-uri
  - secretKey: mongo-root-username
    remoteRef:
      key: nocturnal/mongo-root-username
  - secretKey: mongo-root-password
    remoteRef:
      key: nocturnal/mongo-root-password
  - secretKey: redis-password
    remoteRef:
      key: nocturnal/redis-password
  - secretKey: jwt-secret
    remoteRef:
      key: nocturnal/jwt-secret
  - secretKey: smtp-user
    remoteRef:
      key: nocturnal/smtp-user
  - secretKey: smtp-password
    remoteRef:
      key: nocturnal/smtp-password
